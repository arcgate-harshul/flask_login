<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Call</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- Agora Web SDK -->
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.20.2.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <div class="dashboard-header">
            <h2>Video Call</h2>
            <div>
                <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Back to Dashboard</a>
                <a href="{{ url_for('logout') }}" class="btn btn-secondary">Logout</a>
            </div>
        </div>

        <!-- New HTTPS Warning -->
        <div class="alert alert-warning" id="https-warning">
            <strong>Important:</strong> Your browser requires a secure connection (HTTPS) to access your camera and microphone. This feature may not work correctly on an insecure connection.
        </div>

        <div class="video-call-container">
            <!-- Video streams will be injected here -->
            <div id="local-player" class="video-player"></div>
            <div id="remote-player-list"></div>
        </div>

        <div class="video-controls">
            <button id="join-btn" class="btn">Join Call</button>
            <button id="leave-btn" class="btn btn-delete" style="display: none;">Leave Call</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- Basic setup ---
            const client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
            let localTracks = [];
            let remoteUsers = {};

            // --- DOM Elements ---
            const joinBtn = document.getElementById("join-btn");
            const leaveBtn = document.getElementById("leave-btn");
            const localPlayerContainer = document.getElementById("local-player");
            const remotePlayerList = document.getElementById("remote-player-list");
            const httpsWarning = document.getElementById("https-warning");

            // Hide warning if the connection is secure
            if (window.location.protocol === "https:") {
                httpsWarning.style.display = "none";
            }

            // --- Agora Event Handlers ---
            const handleUserPublished = async (user, mediaType) => {
                console.log(`User ${user.uid} published media: ${mediaType}`);
                await client.subscribe(user, mediaType);
                console.log("Subscribe success");

                if (mediaType === "video") {
                    const remotePlayer = document.createElement("div");
                    remotePlayer.id = `player-${user.uid}`;
                    remotePlayer.className = "video-player";
                    remotePlayerList.append(remotePlayer);
                    user.videoTrack.play(remotePlayer);
                }

                if (mediaType === "audio") {
                    user.audioTrack.play();
                }
            };

            const handleUserUnpublished = (user) => {
                console.log(`User ${user.uid} unpublished.`);
                const playerContainer = document.getElementById(`player-${user.uid}`);
                if (playerContainer) {
                    playerContainer.remove();
                }
            };

            // --- Main Functions ---
            const join = async () => {
                console.log("Join button clicked. Fetching token...");
                try {
                    // Fetch token from our Flask server
                    const response = await fetch('/get_token');
                    const data = await response.json();

                    if (data.error) {
                        alert(data.error);
                        return;
                    }

                    const { appId, channel, token, uid } = data;
                    console.log("Token received. Joining channel...");

                    // Join the channel
                    await client.join(appId, channel, token, uid);
                    console.log("Join success. Creating local tracks...");

                    // Create and publish local tracks (this should trigger permission prompt)
                    localTracks = await AgoraRTC.createMicrophoneAndCameraTracks();
                    console.log("Local tracks created.");
                    
                    localPlayerContainer.innerHTML = ''; // Clear previous content
                    localTracks[1].play(localPlayerContainer); // Play video track
                    console.log("Local video playing.");

                    await client.publish(Object.values(localTracks));
                    console.log("Publish success.");

                    // Update UI
                    joinBtn.style.display = "none";
                    leaveBtn.style.display = "inline-block";
                } catch (error) {
                    console.error("Failed to join channel:", error);
                    alert("Could not join the call. Check the console for errors. This is likely due to an insecure connection (HTTP).");
                }
            };

            const leave = async () => {
                console.log("Leave button clicked.");
                for (let track of localTracks) {
                    track.stop();
                    track.close();
                }
                await client.leave();
                console.log("Leave success.");

                // Clear UI
                localPlayerContainer.innerHTML = '';
                remotePlayerList.innerHTML = '';

                // Update UI
                joinBtn.style.display = "inline-block";
                leaveBtn.style.display = "none";
            };

            // --- Event Listeners ---
            joinBtn.addEventListener("click", join);
            leaveBtn.addEventListener("click", leave);

            client.on("user-published", handleUserPublished);
            client.on("user-unpublished", handleUserUnpublished);
        });
    </script>
</body>
</html>
